<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>SammyDoo ‚Äì Jump & Catch</title>

<style>
body {
  margin:0;
  background:#111;
  color:#fff;
  font-family:Arial,sans-serif;
  text-align:center;
  overflow:hidden;
  overscroll-behavior:none;
}

h1 { margin:10px 0; }

#gameContainer {
  max-width:800px;
  margin:auto;
  position:relative;
}

canvas {
  width:100%;
  aspect-ratio:4/3;
  background:#87CEEB;
  touch-action:none;
  user-select:none;
  -webkit-user-select:none;
}

#ui {
  display:flex;
  justify-content:space-between;
  padding:6px;
}

.badge {
  background:rgba(0,0,0,.6);
  padding:6px 10px;
  border-radius:6px;
  font-size:16px;
}

.comboBadge {
  background:rgba(255,165,0,.85);
  color:#000;
  font-weight:bold;
}

.floating {
  position:absolute;
  color:yellow;
  font-weight:bold;
  pointer-events:none;
  animation:float 1s forwards;
}

@keyframes float {
  from {opacity:1; transform:translateY(0);}
  to {opacity:0; transform:translateY(-40px);}
}
</style>
</head>

<body>
<div id="gameContainer">
  <h1>üê∂ SammyDoo Jump & Catch</h1>
  <canvas id="gameCanvas"></canvas>
  <div id="ui">
    <div id="score" class="badge">Score: 0</div>
    <div id="combo" class="badge comboBadge">Combo: 0</div>
    <div id="timer" class="badge">Time: 120</div>
  </div>
</div>

<script>
/* ================= CANVAS ================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function resize(){
  canvas.width = Math.min(window.innerWidth,800);
  canvas.height = canvas.width * 0.75;
}
resize();
addEventListener('resize',resize);

/* ================= GAME STATE ================= */
let score = 0;
let combo = 0;
let timeLeft = 120;
let lastTime = performance.now();
let shake = 0;

/* ================= PLAYER ================= */
const PW = 80, PH = 80;
let px = canvas.width / 2;
let py = canvas.height - PH;
let vy = 0;
let jumping = false;
let facingRight = true;

const GRAVITY = 2600;
const JUMP = -850;

/* jump forgiveness */
let coyoteTime = 0.12;
let jumpBuffer = 0;
const COYOTE = 0.12;
const JBUF = 0.15;

/* ================= INPUT ================= */
let left = false;
let right = false;

/* keyboard */
addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft') {
    left = true;
    facingRight = false;
  }
  if (e.key === 'ArrowRight') {
    right = true;
    facingRight = true;
  }
  if (e.code === 'Space') {
    jumpBuffer = JBUF;
    if (!jumping) {
      coyoteTime = COYOTE; // ‚úÖ FIX salto
    }
  }
});

addEventListener('keyup', e => {
  if (e.key === 'ArrowLeft') left = false;
  if (e.key === 'ArrowRight') right = false;
});

/* touch */
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  const x = e.touches[0].clientX;

  if (x < innerWidth / 2) {
    left = true;
    facingRight = false;
  } else {
    right = true;
    facingRight = true;
  }

  jumpBuffer = JBUF;
  if (!jumping) {
    coyoteTime = COYOTE; // ‚úÖ FIX salto
  }
}, { passive:false });

canvas.addEventListener('touchend', () => {
  left = false;
  right = false;
}, { passive:false });

canvas.addEventListener('touchmove', e => e.preventDefault(), { passive:false });

/* ================= IMAGES ================= */
function img(src){ const i = new Image(); i.src = src; return i; }

const IMG = {
  bg: img('park.png'),
  run: [img('sam_run1.png'), img('sam_run2.png')],
  jump: img('sam_jump.png')
};

/* ================= OBJECTS ================= */
const ITEM_SCALE = 0.75;

const OBJECTS = [
  { img: img('frisbee.png'), pts: 10, size: 40*ITEM_SCALE, speed: 220 },
  { img: img('ball.png'), pts: 8,  size: 30*ITEM_SCALE, speed: 250 },
  { img: img('stick.png'), pts: 5, size: 45*ITEM_SCALE, speed: 200 },
  { img: img('star.png'), special:'x2', size: 40*ITEM_SCALE, speed:240, chance:0.12 },
  { img: img('bone.png'), special:'time', size: 40*ITEM_SCALE, speed:240, chance:0.12 }
];

/* ================= AUDIO ================= */
const sounds = {
  bg: new Audio('bg_music.mp3'),
  collect: new Audio('collect.wav'),
  power: new Audio('power.wav')
};
sounds.bg.loop = true;
sounds.bg.volume = 0.18;
sounds.collect.volume = 0.7;
sounds.power.volume = 0.8;

let audioUnlocked = false;
addEventListener('touchstart', () => {
  if (!audioUnlocked) {
    audioUnlocked = true;
    sounds.bg.play().catch(()=>{});
  }
}, { once:true });

/* ================= COMBO ================= */
function comboMultiplier() {
  if (combo >= 10) return 4;
  if (combo >= 6) return 3;
  if (combo >= 3) return 2;
  return 1;
}

/* ================= ITEMS ================= */
let items = [];
let spawnRate = 1.2;

function floatText(text, x, y) {
  const d = document.createElement('div');
  d.className = 'floating';
  d.textContent = text;
  d.style.left = (canvas.offsetLeft + x) + 'px';
  d.style.top  = (canvas.offsetTop + y) + 'px';
  document.body.appendChild(d);
  setTimeout(() => d.remove(), 1000);
}

/* ================= UPDATE ================= */
let anim = 0;

function update(dt) {
  if (left) px -= 400 * dt;
  if (right) px += 400 * dt;
  px = Math.max(PW/2, Math.min(canvas.width - PW/2, px));

  if (!jumping) coyoteTime -= dt;

  if (jumpBuffer > 0 && coyoteTime > 0 && !jumping) {
    jumping = true;
    vy = JUMP;
    jumpBuffer = 0;
    coyoteTime = 0;
  }

  if (jumping) {
    vy += GRAVITY * dt;
    py += vy * dt;
    if (py >= canvas.height - PH) {
      py = canvas.height - PH;
      vy = 0;
      jumping = false;
      coyoteTime = COYOTE;
    }
  }

  jumpBuffer = Math.max(0, jumpBuffer - dt);

  spawnRate += dt * 0.008;
  spawnRate = Math.min(spawnRate, 2.2);

  if (Math.random() < spawnRate * dt && items.length < 4) {
    let t;
    do {
      t = OBJECTS[Math.floor(Math.random() * OBJECTS.length)];
    } while (t.special && Math.random() > t.chance);
    items.push({ t, x:Math.random()*canvas.width, y:-40, collected:false });
  }

  items.forEach(o => {
    o.y += o.t.speed * dt;

    if (o.y > canvas.height + 40 && !o.collected) {
      combo = 0;
      o.dead = true;
    }

    if (
      Math.abs(o.x - px) < 40 &&
      Math.abs(o.y - (py + 40)) < 40 &&
      jumping
    ) {
      o.collected = true;
      o.dead = true;

      if (o.t.special === 'x2') {
        floatText('x2!', o.x, o.y);
        sounds.power.play().catch(()=>{});
      } else if (o.t.special === 'time') {
        timeLeft += 5;
        floatText('+5s', o.x, o.y);
        sounds.power.play().catch(()=>{});
      } else {
        combo++;
        const gain = o.t.pts * comboMultiplier();
        score += gain;
        floatText(`+${gain}`, o.x, o.y);
        sounds.collect.play().catch(()=>{});
      }
      shake = 0.12;
    }
  });

  items = items.filter(o => !o.dead);
  anim += dt * 10;
}

/* ================= DRAW ================= */
function draw() {
  ctx.save();
  if (shake > 0) {
    ctx.translate(Math.random()*6-3, Math.random()*6-3);
    shake -= 0.016;
  }

  ctx.drawImage(IMG.bg,0,0,canvas.width,canvas.height);

  let pImg;
  if (jumping) pImg = IMG.jump;
  else if (left || right) pImg = IMG.run[Math.floor(anim) % 2];
  else pImg = IMG.run[0];

  ctx.save();
  if (!facingRight) {
    ctx.translate(px, 0);
    ctx.scale(-1,1);
    ctx.drawImage(pImg, -PW/2, py, PW, PH);
  } else {
    ctx.drawImage(pImg, px - PW/2, py, PW, PH);
  }
  ctx.restore();

  items.forEach(o => {
    ctx.drawImage(
      o.t.img,
      o.x - o.t.size/2,
      o.y - o.t.size/2,
      o.t.size, o.t.size
    );
  });

  ctx.restore();

  scoreEl.textContent = 'Score: ' + score;
  comboEl.textContent = 'Combo: ' + combo;
  timerEl.textContent = 'Time: ' + timeLeft;
}

/* ================= LOOP ================= */
setInterval(() => {
  timeLeft--;
  if (timeLeft <= 0) location.reload();
}, 1000);

const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const timerEl = document.getElementById('timer');

function loop(t) {
  const dt = Math.min((t - lastTime) / 1000, 0.05);
  lastTime = t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
