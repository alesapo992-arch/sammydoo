<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>SammyDoo ‚Äì Jump & Catch</title>

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:Arial,sans-serif;
  text-align:center;
  overflow:hidden;
}
h1{margin:8px 0}

#gameContainer{
  max-width:800px;
  margin:auto;
  position:relative;
}

canvas{
  width:100%;
  aspect-ratio:4/3;
  background:#87CEEB;
  touch-action:none;
  user-select:none;
  border:2px solid #fff; /* Debug: bordo visibile */
  display:block;
}

#ui{
  display:flex;
  justify-content:space-around;
  padding:6px 12px;
  flex-wrap:wrap;
  gap:4px;
}
.badge, .itemUI{
  background:rgba(0,0,0,.7);
  padding:8px 12px;
  border-radius:8px;
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  min-height:32px;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
}
.itemUI img{
  image-rendering:pixelated;
  border-radius:4px;
  box-shadow:0 2px 4px rgba(0,0,0,0.3);
  width:26px;
  height:26px;
}
#healthBarBg{
  width:50px;
  height:10px;
  background:rgba(0,0,0,0.8);
  border-radius:5px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.2);
}
#healthBar{
  height:100%;
  background:linear-gradient(90deg, #ff4444 0%, #ffaa44 50%, #44ff44 100%);
  border-radius:4px;
  width:100%;
  transition:width 0.2s ease;
  box-shadow:0 0 8px rgba(255,255,255,0.5);
}

#gameOverScreen{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:10;
  backdrop-filter:blur(4px);
}
#gameOverScreen h2{
  font-size:42px;
  color:#ff4444;
  text-shadow:0 0 20px #ff4444;
}
button{
  margin-top:20px;
  padding:14px 32px;
  font-size:20px;
  background:#4dff4d;
  color:#000;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
  box-shadow:0 4px 12px rgba(77,255,77,0.4);
  transition:transform 0.1s;
}
button:hover{transform:scale(1.05);}

#warning{
  position:absolute;
  top:50%;
  left:50%;
  width:70px;
  height:70px;
  transform:translate(-50%, -50%);
  display:none;
  animation:blink 0.4s infinite;
  z-index:9;
  filter:drop-shadow(0 0 20px #ff4444);
}

@keyframes blink{
  0%{opacity:1; transform:translate(-50%, -50%) scale(1);}
  50%{opacity:0.3; transform:translate(-50%, -50%) scale(1.1);}
  100%{opacity:1; transform:translate(-50%, -50%) scale(1);}
}

/* Debug overlay */
#debug{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,0.8);
  padding:10px;
  border-radius:8px;
  font-size:12px;
  z-index:11;
  display:none;
}
</style>
</head>

<body>
<div id="gameContainer">
  <h1>üê∂ SammyDoo Jump & Catch</h1>
  <img id="warning" src="warning.png" style="display:none;">
  <canvas id="gameCanvas"></canvas>

  <div id="ui">
    <div id="score" class="badge">Score: 0</div>
    
    <div id="frisbeeUI" class="itemUI">
      <img src="frisbee.png" width="26" height="26" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjYiIGhlaWdodD0iMjYiIHZpZXdCb3g9IjAgMCAyNiAyNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMyIgY3k9IjEzIiByPSIxMyIgZmlsbD0iI2ZmZjYwMCIvPjxwYXRoIGQ9Ik0xMyAxM2MtMi4yMDMgMCA0LjAzIDQuMDMtMi4yMDMgNi4yMzNMMTEuNzcgMjBDMTMuOTcgMTggMTMgMTMgMTMgMTNaIiBmaWxsPSIjZmZmIj48L3BhdGg+PC9zdmc+'">
      <span id="frisCount">0</span>/5
    </div>
    
    <div id="stickUI" class="itemUI">
      <img src="stick.png" width="26" height="26" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjYiIGhlaWdodD0iMjYiIHZpZXdCb3g9IjAgMCAyNiAyNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMCAxM2gxMHYxMEgxMHYtMTBIMHoiIGZpbGw9IiM4YjQ1MTMiLz48L3N2Zz4='">
      <span id="stickCount">0</span>/5
    </div>
    
    <div id="health" class="badge">
      ‚ù§Ô∏è
      <div id="healthBarBg">
        <div id="healthBar"></div>
      </div>
    </div>
    
    <div id="high" class="badge">High: 0</div>
  </div>

  <div id="gameOverScreen">
    <h2>GAME OVER</h2>
    <button onclick="restartGame()">RESTART üêï</button>
  </div>

  <!-- Debug (rimuovi dopo test) -->
  <div id="debug"></div>
</div>

<script>
/* ================= DEBUG ================= */
const debugEl = document.getElementById('debug');
function logDebug(msg){
  debugEl.innerHTML += msg + '<br>';
  debugEl.style.display = 'block';
  console.log(msg);
}

/* ================= AUDIO ================= */
const sounds = {
  bg: new Audio("bg_music.mp3"),
  collect: new Audio("collect.wav"),
  jump: new Audio("jump.wav"),
  negative: new Audio("negative.wav"),
  miss: new Audio("miss.wav"),
  gameOver: new Audio("game_over.wav"),
  warning: new Audio("dog_warning.wav"),
  bite: new Audio("bite.wav"),
  bonus: new Audio("bonus.wav")
};
sounds.bg.loop = true;
sounds.bg.volume = 0.08;
Object.keys(sounds).forEach(k => {
  if(k !== 'bg') sounds[k].volume = 0.8;
});

let audioUnlocked = false;
function unlockAudio(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  sounds.bg.play().catch(e => console.warn('Audio unlock failed:', e));
}
['touchstart','mousedown','keydown'].forEach(e => {
  document.addEventListener(e, unlockAudio, {once: true});
});

/* ================= CANVAS ================= */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
logDebug('Canvas & ctx OK');

const PW = 80, PH = 80;

/* ================= GAME STATE (PRIMA di resize!) ================= */
let score = 0;
let highScore = +localStorage.getItem("sammyHigh") || 0;
let health = 100;
let lastTime = performance.now();
let gameOver = false;
let shake = 0;
let combo = 0;
let frisbeeCount = 0;
let stickCount = 0;
let px = 0, py = 0; // Inizializzati qui
let vy = 0, jumping = false, facingRight = true;
let coyoteTime = 0.12;
let jumpBuffer = 0;
let left = false, right = false;
let items = [];
let particles = [];
let dog = null;
let dogAnim = 0;
let dogSpawnTimer = 0;
let spawnRate = 1.1;
let difficultyLevel = 1;

const GRAVITY = 2600;
const JUMP = -850;
const MISS_DAMAGE = 15;
const NEGATIVE_DAMAGE = 10;
const BONE_HEALTH = 25;
const COLL_BONUS = 50;
const MAX_COLLECT = 5;
const MAX_HEALTH = 100;
const DOG_SPAWN_INTERVAL = 22;
const DOG_DAMAGE = 35;

logDebug('Game state init OK');

/* ================= RESIZE (ORA sicuro) ================= */
function resize(){
  canvas.width = Math.min(innerWidth, 800);
  canvas.height = canvas.width * 0.75;
  px = canvas.width / 2;
  py = canvas.height - PH;
  logDebug(`Resize: ${canvas.width}x${canvas.height}, px=${px}`);
}
resize();
window.addEventListener("resize", resize);

/* ================= IMAGES ================= */
function img(s){
  const i = new Image();
  i.src = s;
  i.onerror = () => logDebug(`Image load fail: ${s}`);
  return i;
}
const IMG = {
  bg: img("park.png"),
  run: [img("sam_run1.png"), img("sam_run2.png")],
  jump: img("sam_jump.png"),
  dog: [img("dog1.png"), img("dog2.png")]
};
logDebug('Images queued OK');

/* ================= OBJECTS ================= */
const ITEM_SCALE = 0.75;
const SPEED_SCALE = 0.8;
const OBJECTS = [
  {img: img("frisbee.png"), id: 'frisbee', pts: 10, size: 40 * ITEM_SCALE, speed: 200 * SPEED_SCALE, isPositive: true},
  {img: img("ball.png"), id: 'ball', pts: 8, size: 30 * ITEM_SCALE, speed: 220 * SPEED_SCALE, isPositive: true},
  {img: img("stick.png"), id: 'stick', pts: 5, size: 45 * ITEM_SCALE, speed: 190 * SPEED_SCALE, isPositive: true},
  {img: img("bone.png"), id: 'bone', special: 'health', size: 40 * ITEM_SCALE, speed: 210 * SPEED_SCALE, chance: 0.15, isPositive: true},
  {img: img("caffettiera.png"), id: 'coffee', pts: -15, size: 55, speed: 190 * SPEED_SCALE, chance: 0.15, isPositive: false},
  {img: img("secchio.png"), id: 'bucket', pts: -10, size: 55, speed: 190 * SPEED_SCALE, chance: 0.2, isPositive: false}
];
logDebug('Objects OK');

/* ================= INPUT ================= */
let touchSX = 0, touchSY = 0;
const SWIPE_THRESHOLD = 35;

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  const t = e.touches[0];
  touchSX = t.clientX; touchSY = t.clientY;
}, {passive: false});

canvas.addEventListener("touchend", e => {
  e.preventDefault();
  const t = e.changedTouches[0];
  const dx = t.clientX - touchSX;
  const dy = t.clientY - touchSY;

  if (dy < -SWIPE_THRESHOLD && Math.abs(dy) > Math.abs(dx)) {
    jumpBuffer = 0.15;
    if (!jumping) coyoteTime = 0.12;
    return;
  }

  if (dx < -SWIPE_THRESHOLD) {
    left = true; facingRight = false;
    setTimeout(() => left = false, 140);
  } else if (dx > SWIPE_THRESHOLD) {
    right = true; facingRight = true;
    setTimeout(() => right = false, 140);
  }
}, {passive: false});

document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") { left = true; facingRight = false; }
  if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") { right = true; facingRight = true; }
  if ((e.key === "ArrowUp" || e.key === "w" || e.key === "W") && !jumping) { jumpBuffer = 0.15; coyoteTime = 0.12; }
});
document.addEventListener("keyup", e => {
  if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") left = false;
  if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") right = false;
});

/* ================= FUNCTIONS ================= */
function spawnParticles(x, y, color, count = 8, life = 0.5) {
  for (let i = 0; i < count; i++) {
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 250,
      vy: (Math.random() - 0.8) * 200,
      life,
      color,
      size: Math.random() * 4 + 1
    });
  }
}

const warningEl = document.getElementById("warning");
function spawnDog() {
  const fromRight = Math.random() < 0.5;
  dog = {
    x: fromRight ? canvas.width + 120 : -120,
    y: canvas.height - PH + 10,
    w: 90,
    h: 70,
    speed: (fromRight ? -1 : 1) * (240 + difficultyLevel * 25),
    dir: fromRight ? 'right' : 'left'
  };
  dogAnim = 0;
  warningEl.style.display = "block";
  sounds.warning.play().catch(() => {});
  setTimeout(() => { warningEl.style.display = "none"; }, 1800);
}

/* ================= UPDATE ================= */
function update(dt) {
  if (gameOver) return;

  // Movement
  if (left) px -= 420 * dt;
  if (right) px += 420 * dt;
  px = Math.max(PW / 2, Math.min(canvas.width - PW / 2, px));

  // Jump
  if (!jumping) coyoteTime -= dt;
  jumpBuffer = Math.max(0, jumpBuffer - dt);
  if (jumpBuffer > 0 && coyoteTime > 0 && !jumping) {
    jumping = true; vy = JUMP;
    jumpBuffer = 0; coyoteTime = 0;
    sounds.jump.play().catch(() => {});
    combo = 0;
  }

  if (jumping) {
    vy += GRAVITY * dt;
    py += vy * dt;
    if (py >= canvas.height - PH) {
      py = canvas.height - PH;
      vy = 0; jumping = false;
      coyoteTime = 0.12;
    }
  }

  // Difficulty
  spawnRate = 1.2 + Math.floor(score / 400) * 0.25;
  difficultyLevel = 1 + Math.floor(score / 800) * 0.15;

  // Spawn items
  if (Math.random() < spawnRate * dt && items.length < 6) {
    let t;
    do {
      t = OBJECTS[Math.floor(Math.random() * OBJECTS.length)];
    } while (t.chance && Math.random() > t.chance);
    items.push({ t, x: Math.random() * canvas.width, y: -50, rotation: 0 });
  }

  // Items update
  items.forEach(o => {
    o.y += o.t.speed * difficultyLevel * dt;
    o.rotation += 4 * dt;

    // Collect
    if (Math.abs(o.x - px) < 48 && Math.abs(o.y - (py + 35)) < 48 && jumping) {
      let pts = o.t.pts || 0;
      let collectedBonus = false;

      if (o.t.id === 'frisbee') {
        frisbeeCount++;
        if (frisbeeCount >= MAX_COLLECT) {
          health = Math.min(MAX_HEALTH, health + COLL_BONUS);
          collectedBonus = true;
          frisbeeCount = 0;
          spawnParticles(px, py + 20, "#4dff4d", 25, 0.8);
          sounds.bonus.play().catch(() => {});
        }
      } else if (o.t.id === 'stick') {
        stickCount++;
        if (stickCount >= MAX_COLLECT) {
          health = Math.min(MAX_HEALTH, health + COLL_BONUS);
          collectedBonus = true;
          stickCount = 0;
          spawnParticles(px, py + 20, "#44ffaa", 25, 0.8);
          sounds.bonus.play().catch(() => {});
        }
      } else if (o.t.special === 'health') {
        health = Math.min(MAX_HEALTH, health + BONE_HEALTH);
        spawnParticles(o.x, o.y, "#00ff88", 20, 0.7);
        sounds.bonus.play().catch(() => {});
        collectedBonus = true;
      }

      if (pts !== undefined) {
        combo++;
        if (combo >= 3) pts *= 1.5;
        score += pts;
      }

      if (!collectedBonus) {
        if (pts < 0) {
          health -= NEGATIVE_DAMAGE;
          shake = 0.45;
          spawnParticles(o.x, o.y, "#ff4d4d", 16);
          sounds.negative.play().catch(() => {});
        } else {
          spawnParticles(o.x, o.y, "#ffe066", 12);
          sounds.collect.play().catch(() => {});
        }
      }
      o.dead = true;
    }
  });

  // Miss
  items.forEach(o => {
    if (o.y > canvas.height + 60 && !o.dead && o.t.isPositive) {
      health -= MISS_DAMAGE;
      shake = 0.25;
      sounds.miss.play().catch(() => {});
      spawnParticles(o.x, canvas.height, "#ffaa44", 10);
      o.dead = true;
    }
  });
  items = items.filter(o => !o.dead && o.y < canvas.height + 80);

  // Dog spawn
  dogSpawnTimer += dt;
  if (!dog && dogSpawnTimer > DOG_SPAWN_INTERVAL / difficultyLevel) {
    spawnDog();
    dogSpawnTimer = 0;
  }

  // Dog
  if (dog) {
    dog.x += dog.speed * dt;
    dogAnim += dt * 12;

    if (!jumping &&
        px + PW / 2 > dog.x &&
        px - PW / 2 < dog.x + dog.w &&
        py + PH > dog.y) {
      health -= DOG_DAMAGE;
      shake = 0.7;
      sounds.bite.play().catch(() => {});
      spawnParticles(px, py + PH / 2, "#ff2222", 30, 0.6);
      dog = null;
      dogSpawnTimer = 0;
    }

    if ((dog.dir === 'left' && dog.x > canvas.width + 120) ||
        (dog.dir === 'right' && dog.x < -120)) {
      dog = null;
    }
  }

  // Particles
  particles.forEach(p => {
    p.vy += 700 * dt;
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.life -= dt;
    p.vx *= 0.98;
    p.vy *= 0.98;
  });
  particles = particles.filter(p => p.life > 0);

  shake = Math.max(0, shake - dt * 3);

  health = Math.max(0, Math.min(MAX_HEALTH, health));
  if (health <= 0) endGame();

  // UI
  document.getElementById('score').textContent = "Score: " + Math.floor(score);
  document.getElementById('high').textContent = "High: " + Math.floor(highScore);
  document.getElementById('frisCount').textContent = frisbeeCount;
  document.getElementById('stickCount').textContent = stickCount;
  document.getElementById('healthBar').style.width = (health / 100 * 100) + "%";
}

/* ================= DRAW ================= */
function draw() {
  ctx.save();
  if (shake > 0) {
    const s = (Math.sin(Date.now() / 50) * shake * 12);
    ctx.translate(s, s * 0.7);
  }

  ctx.imageSmoothingEnabled = false;
  ctx.fillStyle = '#87CEEB'; // Background fallback
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  if (IMG.bg.complete) ctx.drawImage(IMG.bg, 0, 0, canvas.width, canvas.height);

  // Player
  let pImg = jumping
    ? IMG.jump
    : (left || right ? IMG.run[Math.floor(performance.now() / 140) % 2] : IMG.run[0]);
  if (pImg.complete || pImg === IMG.jump) { // Skip if not loaded
    ctx.save();
    if (!facingRight) {
      ctx.translate(px, py + PH / 2);
      ctx.scale(-1, 1);
      ctx.drawImage(pImg, -PW / 2, -PH / 2, PW, PH);
    } else {
      ctx.drawImage(pImg, px - PW / 2, py, PW, PH);
    }
    ctx.restore();
  }

  // Items
  items.forEach(o => {
    if (o.t.img.complete) {
      ctx.save();
      ctx.translate(o.x, o.y);
      ctx.rotate(o.rotation);
      ctx.drawImage(o.t.img, -o.t.size / 2, -o.t.size / 2, o.t.size, o.t.size);
      ctx.restore();
    }
  });

  // Dog
  if (dog && IMG.dog[0].complete) {
    const f = Math.floor(dogAnim) % 2;
    ctx.save();
    if (dog.dir === 'right') {
      ctx.translate(dog.x + dog.w / 2, dog.y + dog.h / 2);
      ctx.scale(-1, 1);
      ctx.drawImage(IMG.dog[f], -dog.w / 2, -dog.h / 2, dog.w, dog.h);
    } else {
      ctx.drawImage(IMG.dog[f], dog.x, dog.y, dog.w, dog.h);
    }
    ctx.restore();
  }

  // Particles
  particles.forEach(p => {
    ctx.save();
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 8;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  });

  ctx.imageSmoothingEnabled = true;
  ctx.restore();
}

/* ================= GAME OVER ================= */
function endGame() {
  gameOver = true;
  sounds.bg.pause();
  sounds.gameOver.play().catch(() => {});
  highScore = Math.max(highScore, score);
  localStorage.setItem("sammyHigh", Math.floor(highScore));
  document.getElementById("gameOverScreen").style.display = "flex";
}
function restartGame() {
  location.reload();
}

/* ================= LOOP ================= */
function loop(t) {
  const dt = Math.min((t - lastTime) / 1000, 0.05);
  lastTime = t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
logDebug('Loop started');
requestAnimationFrame(loop);

// BG music
setTimeout(() => { sounds.bg.play().catch(() => {}); }, 500);
</script>
</body>
</html>
